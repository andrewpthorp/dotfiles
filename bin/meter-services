#!/usr/bin/env sh

# meter-services
# version 0.2

# Contributors:
#   Andrew Thorp - https://github.com/andrewpthorp

# Usage:
#   meter-services

# This will spawn a new tmux-session (if it does not exist), which will do the
# following tasks:
#
# Create 7 windows:
#
# Window 1: Vim in frontends
# Window 2: Shell at ~/code/meter/frontends
# Window 3: pnpm i && pnpm run dev dashboard
# Window 4: Vim in api
# Window 5: Shell at ~/code/meter/api
# Window 6: Claude at ~/code/meter
# Window 7: Atto

set -e

SESSION='meter-services'

_launch_services() {

  # Window 1: Vim in frontends
  tmux new-session -s "$SESSION" -n vim-frontends -d -c "$HOME/code/meter/frontends"
  tmux send-keys "$EDITOR" C-m

  # Window 2: Shell at ~/code/meter/frontends
  tmux new-window -n shell-frontends -t "$SESSION" -c "$HOME/code/meter/frontends"

  # Window 3: pnpm i && pnpm run dev dashboard
  tmux new-window -n dashboard -t "$SESSION" -c "$HOME/code/meter/frontends"
  tmux send-keys "sleep 1 && pnpm i && pnpm run dev dashboard" C-m

  # Window 4: Vim in api
  tmux new-window -n vim-api -t "$SESSION" -c "$HOME/code/meter/api"
  tmux send-keys "$EDITOR" C-m

  # Window 5: Shell at ~/code/meter/api
  tmux new-window -n shell-api -t "$SESSION" -c "$HOME/code/meter/api"

  # Window 6: Claude at ~/code/meter
  tmux new-window -n claude -t "$SESSION" -c "$HOME/code/meter"
  tmux send-keys "sleep 1 && claude" C-m

  # Window 7: Atto
  tmux new-window -n atto -t "$SESSION" -c "$HOME/code/meter/frontends"
  tmux send-keys "sleep 2 && pnpm run dev @meterup/atto" C-m

}

_session_exists() {
  tmux has-session -t "$SESSION" 2>/dev/null
}

# If session exists, attach to it
if _session_exists; then
  tmux attach -t "$SESSION"
  exit 0
fi

# Otherwise, create a new session
_launch_services

# Select the first window and attach
tmux select-window -t "$SESSION:1"
tmux attach -t "$SESSION"
